generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model m_tenant {
  tenant_id             Int                    @id @default(autoincrement())
  tenant_name           String                 @unique
  tenant_phone          String?
  tenant_email          String?
  tenant_description    String?                @db.Text
  tenant_address        String?                @db.Text
  store_logo_url        String?
  store_business_hours  String?
  store_description     String?
  tenant_status         tenant_status          @default(PENDING)
  is_active             Boolean                @default(false)
  approved_by           Int?
  approved_at           DateTime?
  rejected_by           Int?
  rejected_at           DateTime?
  rejection_reason      String?                @db.Text
  max_users             Int                    @default(7)
  created_by            Int?
  updated_by            Int?
  deleted_by            Int?
  created_at            DateTime               @default(now())
  updated_at            DateTime               @updatedAt
  deleted_at            DateTime?
  m_user_approved_by    m_user?                @relation("TenantApprovedBy", fields: [approved_by], references: [user_id])
  m_user_rejected_by    m_user?                @relation("TenantRejectedBy", fields: [rejected_by], references: [user_id])
  m_user_created_by     m_user?                @relation("TenantCreatedBy", fields: [created_by], references: [user_id])
  m_user_updated_by     m_user?                @relation("TenantUpdatedBy", fields: [updated_by], references: [user_id])
  m_user_deleted_by     m_user?                @relation("TenantDeletedBy", fields: [deleted_by], references: [user_id])
  m_brand               m_brand[]
  m_category            m_category[]
  m_product             m_product[]
  m_user                m_user[]
  s_registration_pin    s_registration_pin[]
  s_registration_tenant s_registration_tenant?
  t_stock_movement      t_stock_movement[]
  t_stock_opname        t_stock_opname[]
  t_transaction         t_transaction[]
  t_cash_transaction    t_cash_transaction[]
  t_return              t_return[]
  t_expense_category    t_expense_category[]

  @@index([approved_by])
  @@index([rejected_by])
  @@map("m_tenant")
}

model m_user {
  user_id                           Int                    @id @default(autoincrement())
  user_name                         String                 @unique
  user_email                        String                 @unique
  user_password                     String?
  tenant_id                         Int?
  role_id                           Int?
  user_full_name                    String?
  user_phone                        String?
  is_sa                             Boolean                @default(false)
  is_active                         Boolean                @default(false)
  user_is_verified                  Boolean                @default(false)
  user_last_login                   DateTime?
  user_locked_until                 DateTime?
  user_login_attempts               Int                    @default(0)
  approved_by                       Int?
  approved_at                       DateTime?
  rejected_by                       Int?
  rejected_at                       DateTime?
  rejection_reason                  String?                @db.Text
  registration_step                 Int                    @default(1)
  registration_type                 registration_type?
  approved_by_owner                 Int?
  approved_at_owner                 DateTime?
  created_by                        Int?
  updated_by                        Int?
  deleted_by                        Int?
  created_at                        DateTime               @default(now())
  updated_at                        DateTime               @updatedAt
  deleted_at                        DateTime?
  user_approved_by_owner            m_user?                @relation("EmployeeApprovedBy", fields: [approved_by_owner], references: [user_id])
  user_approved_employees           m_user[]               @relation("EmployeeApprovedBy")
  m_user_approved_by                m_user?                @relation("UserApprovedBy", fields: [approved_by], references: [user_id])
  m_user_rejected_by                m_user?                @relation("UserRejectedBy", fields: [rejected_by], references: [user_id])
  m_user_created_by                 m_user?                @relation("UserCreatedBy", fields: [created_by], references: [user_id])
  m_user_updated_by                 m_user?                @relation("UserUpdatedBy", fields: [updated_by], references: [user_id])
  m_user_deleted_by                 m_user?                @relation("UserDeletedBy", fields: [deleted_by], references: [user_id])
  m_user_as_approved_by             m_user[]               @relation("UserApprovedBy")
  m_user_as_rejected_by             m_user[]               @relation("UserRejectedBy")
  m_user_as_created_by              m_user[]               @relation("UserCreatedBy")
  m_user_as_updated_by              m_user[]               @relation("UserUpdatedBy")
  m_user_as_deleted_by              m_user[]               @relation("UserDeletedBy")
  m_role                            m_role?                @relation(fields: [role_id], references: [role_id])
  m_tenant                          m_tenant?              @relation(fields: [tenant_id], references: [tenant_id])
  m_tenant_as_approved_by           m_tenant[]             @relation("TenantApprovedBy")
  m_tenant_as_rejected_by           m_tenant[]             @relation("TenantRejectedBy")
  m_tenant_as_created_by            m_tenant[]             @relation("TenantCreatedBy")
  m_tenant_as_updated_by            m_tenant[]             @relation("TenantUpdatedBy")
  m_tenant_as_deleted_by            m_tenant[]             @relation("TenantDeletedBy")
  s_email_verification              s_email_verification[]
  s_registration_pin                s_registration_pin[]
  s_registration_tenant             s_registration_tenant?
  s_registration_user               s_registration_user?
  t_transaction                     t_transaction[]
  t_transaction_as_updated_by       t_transaction[]        @relation("TransactionUpdatedBy")
  t_transaction_as_deleted_by       t_transaction[]        @relation("TransactionDeletedBy")
  t_stock_movement_created          t_stock_movement[]     @relation("StockMovementCreatedBy")
  t_stock_opname_created            t_stock_opname[]       @relation("StockOpnameCreatedBy")
  t_cash_transaction_as_verified_by t_cash_transaction[]   @relation("CashTransactionVerifiedBy")
  t_cash_transaction_as_created_by  t_cash_transaction[]   @relation("CashTransactionCreatedBy")
  t_cash_transaction_as_updated_by  t_cash_transaction[]   @relation("CashTransactionUpdatedBy")
  t_return                          t_return[]
  t_return_created                  t_return[]             @relation("ReturnCreatedBy")

  @@index([role_id])
  @@index([tenant_id])
  @@index([is_active])
  @@index([approved_by_owner])
  @@map("m_user")
}

model m_role {
  role_id            Int                  @id @default(autoincrement())
  role_name          String               @unique
  role_code          String               @unique
  role_description   String?
  role_level         Int                  @default(0)
  is_active          Boolean              @default(true)
  is_system_role     Boolean              @default(false)
  created_by         Int?
  updated_by         Int?
  deleted_by         Int?
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt
  deleted_at         DateTime?
  m_user             m_user[]
  s_registration_pin s_registration_pin[]

  @@map("m_role")
}

model m_brand {
  brand_id          Int         @id @default(autoincrement())
  brand_name        String      @unique
  brand_description String?     @db.Text
  brand_logo_url    String?
  tenant_id         Int
  is_active         Boolean     @default(true)
  created_by        Int?
  updated_by        Int?
  deleted_by        Int?
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt
  deleted_at        DateTime?
  m_tenant          m_tenant    @relation(fields: [tenant_id], references: [tenant_id])
  m_product         m_product[]

  @@index([tenant_id])
  @@index([is_active])
  @@map("m_brand")
}

model m_category {
  category_id          Int         @id @default(autoincrement())
  category_name        String
  category_description String?     @db.Text
  tenant_id            Int
  is_active            Boolean     @default(true)
  created_by           Int?
  updated_by           Int?
  deleted_by           Int?
  created_at           DateTime    @default(now())
  updated_at           DateTime    @updatedAt
  deleted_at           DateTime?
  m_tenant             m_tenant    @relation(fields: [tenant_id], references: [tenant_id])
  m_product            m_product[]

  @@index([tenant_id])
  @@index([is_active])
  @@map("m_category")
}

model m_product {
  product_id          Int                  @id @default(autoincrement())
  product_name        String
  product_description String?              @db.Text
  product_sku         String?              @unique
  product_image_url   String?
  brand_id            Int?
  category_id         Int?
  tenant_id           Int
  product_price       Decimal              @db.Decimal(10, 2)
  product_cost        Decimal?             @db.Decimal(10, 2)
  product_qty         Int                  @default(0)
  product_min_stock   Int?                 @default(5)
  is_active           Boolean              @default(true)
  is_track_stock      Boolean              @default(true)
  is_sellable         Boolean              @default(true)
  created_by          Int?
  updated_by          Int?
  deleted_by          Int?
  created_at          DateTime             @default(now())
  updated_at          DateTime             @updatedAt
  deleted_at          DateTime?
  m_brand             m_brand?             @relation(fields: [brand_id], references: [brand_id])
  m_category          m_category?          @relation(fields: [category_id], references: [category_id])
  m_tenant            m_tenant             @relation(fields: [tenant_id], references: [tenant_id])
  t_stock_movement    t_stock_movement[]
  t_stock_opname      t_stock_opname[]
  t_transaction_item  t_transaction_item[]
  t_return_item       t_return_item[]

  @@index([brand_id])
  @@index([category_id])
  @@index([tenant_id])
  @@index([product_sku])
  @@index([is_active])
  @@index([is_sellable])
  @@map("m_product")
}

model s_email_verification {
  id          Int               @id @default(autoincrement())
  user_id     Int
  email       String
  code        String            @db.VarChar(10)
  expires_at  DateTime
  verified    Boolean           @default(false)
  verified_at DateTime?
  type        verification_type @default(REGISTRATION)
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt
  m_user      m_user            @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([code])
  @@index([verified])
  @@map("s_email_verification")
}

model s_registration_pin {
  id                  Int                   @id @default(autoincrement())
  code                String                @unique @db.VarChar(20)
  expires_at          DateTime
  used                Boolean               @default(false)
  used_at             DateTime?
  revoked_at          DateTime?
  current_uses        Int                   @default(0)
  max_uses            Int                   @default(1)
  tenant_id           Int
  invited_role_id     Int?
  invitation_notes    String?               @db.Text
  created_by          Int
  created_at          DateTime              @default(now())
  updated_at          DateTime              @updatedAt
  m_user              m_user                @relation(fields: [created_by], references: [user_id])
  m_role              m_role?               @relation(fields: [invited_role_id], references: [role_id])
  m_tenant            m_tenant              @relation(fields: [tenant_id], references: [tenant_id])
  s_registration_user s_registration_user[]

  @@index([tenant_id])
  @@index([code])
  @@index([created_by], map: "s_registration_pin_created_by_fkey")
  @@index([invited_role_id], map: "s_registration_pin_invited_role_id_fkey")
  @@map("s_registration_pin")
}

model s_registration_tenant {
  id                   Int       @id @default(autoincrement())
  user_id              Int       @unique
  tenant_id            Int       @unique
  current_step         Int       @default(1)
  temp_tenant_data     Json?
  temp_user_data       Json?
  registration_done    Boolean   @default(false)
  registration_done_at DateTime?
  created_at           DateTime  @default(now())
  updated_at           DateTime  @updatedAt
  m_tenant             m_tenant  @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  m_user               m_user    @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([tenant_id])
  @@map("s_registration_tenant")
}

model s_registration_user {
  id                   Int                @id @default(autoincrement())
  user_id              Int                @unique
  registration_pin_id  Int
  current_step         Int                @default(1)
  temp_user_data       Json?
  registration_done    Boolean            @default(false)
  registration_done_at DateTime?
  created_at           DateTime           @default(now())
  updated_at           DateTime           @updatedAt
  s_registration_pin   s_registration_pin @relation(fields: [registration_pin_id], references: [id])
  m_user               m_user             @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([registration_pin_id])
  @@map("s_registration_user")
}

enum tenant_status {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum registration_type {
  OWNER
  EMPLOYEE
}

enum verification_type {
  REGISTRATION
  PASSWORD_RESET
  EMAIL_CHANGE
}

enum movement_type {
  IN
  OUT
  ADJUSTMENT
  RETURN
}

enum reference_type {
  PURCHASE
  SALE
  ADJUSTMENT
  RETURN
  OPNAME
}

model t_stock_movement {
  movement_id       Int            @id @default(autoincrement())
  product_id        Int
  movement_type     movement_type
  quantity          Int
  cost_per_unit     Decimal?       @db.Decimal(10, 2)
  reference_type    reference_type
  reference_id      Int?
  notes             String?        @db.Text
  before_qty        Int
  after_qty         Int
  tenant_id         Int
  created_by        Int?
  created_at        DateTime       @default(now())
  m_product         m_product      @relation(fields: [product_id], references: [product_id])
  m_tenant          m_tenant       @relation(fields: [tenant_id], references: [tenant_id])
  m_user_created_by m_user?        @relation("StockMovementCreatedBy", fields: [created_by], references: [user_id])

  @@index([product_id])
  @@index([tenant_id])
  @@index([movement_type])
  @@index([created_at])
  @@map("t_stock_movement")
}

model t_stock_opname {
  opname_id         Int       @id @default(autoincrement())
  product_id        Int
  system_qty        Int
  actual_qty        Int
  difference        Int
  notes             String?   @db.Text
  tenant_id         Int
  created_by        Int?
  created_at        DateTime  @default(now())
  processed         Boolean   @default(false)
  processed_at      DateTime?
  m_product         m_product @relation(fields: [product_id], references: [product_id])
  m_tenant          m_tenant  @relation(fields: [tenant_id], references: [tenant_id])
  m_user_created_by m_user?   @relation("StockOpnameCreatedBy", fields: [created_by], references: [user_id])

  @@index([product_id])
  @@index([tenant_id])
  @@index([created_at])
  @@index([processed])
  @@map("t_stock_opname")
}

enum transaction_status {
  DRAFT
  LOCKED
  COMPLETED
  CANCELLED
}

enum payment_method {
  CASH
  QRIS
  DEBIT
}

model t_transaction {
  transaction_id             Int                  @id @default(autoincrement())
  transaction_number         Int?
  tenant_id                  Int
  transaction_cashier_id     Int
  transaction_total          Decimal              @db.Decimal(12, 2)
  transaction_payment_amount Decimal?             @db.Decimal(12, 2)
  transaction_change_amount  Decimal?             @db.Decimal(12, 2)
  transaction_payment_method payment_method?
  transaction_status         transaction_status   @default(DRAFT)
  transaction_completed_at   DateTime?
  transaction_created_at     DateTime             @default(now())
  transaction_updated_at     DateTime?
  transaction_updated_by     Int?
  deleted_at                 DateTime?
  deleted_by                 Int?
  m_user                     m_user               @relation(fields: [transaction_cashier_id], references: [user_id])
  m_tenant                   m_tenant             @relation(fields: [tenant_id], references: [tenant_id])
  m_user_updated_by          m_user?              @relation("TransactionUpdatedBy", fields: [transaction_updated_by], references: [user_id])
  m_user_deleted_by          m_user?              @relation("TransactionDeletedBy", fields: [deleted_by], references: [user_id])
  t_transaction_item         t_transaction_item[]
  t_return_as_original       t_return[]           @relation("OriginalTransaction")
  t_cash_transaction         t_cash_transaction[] @relation("SaleTransaction")

  @@index([tenant_id])
  @@index([transaction_cashier_id])
  @@index([transaction_status])
  @@index([transaction_created_at])
  @@map("t_transaction")
}

model t_transaction_item {
  transaction_item_id         Int           @id @default(autoincrement())
  transaction_id              Int
  transaction_item_product_id Int
  transaction_item_quantity   Int
  transaction_item_price      Decimal       @db.Decimal(10, 2)
  transaction_item_subtotal   Decimal       @db.Decimal(12, 2)
  t_transaction               t_transaction @relation(fields: [transaction_id], references: [transaction_id], onDelete: Cascade)
  m_product                   m_product     @relation(fields: [transaction_item_product_id], references: [product_id])

  @@index([transaction_id])
  @@index([transaction_item_product_id])
  @@map("t_transaction_item")
}

enum cash_transaction_type {
  INCOME
  EXPENSE
}

model t_expense_category {
  category_id          Int       @id @default(autoincrement())
  category_code        String    @unique @db.VarChar(50)
  category_name        String    @db.VarChar(100)
  category_description String?   @db.Text
  tenant_id            Int?
  is_active            Boolean   @default(true)
  is_system            Boolean   @default(false)
  created_by           Int?
  updated_by           Int?
  created_at           DateTime  @default(now())
  updated_at           DateTime  @updatedAt
  m_tenant             m_tenant? @relation(fields: [tenant_id], references: [tenant_id])

  t_cash_transaction t_cash_transaction[]

  @@index([tenant_id])
  @@index([category_code])
  @@index([is_active])
  @@map("t_expense_category")
}

model t_cash_transaction {
  cash_transaction_id Int    @id @default(autoincrement())
  transaction_number  String @unique @db.VarChar(50)
  tenant_id           Int

  transaction_type cash_transaction_type
  amount           Decimal               @db.Decimal(15, 2)
  payment_method   payment_method

  category_id   Int?
  category_type String? @db.VarChar(20)

  sale_transaction_id Int?

  description       String? @db.Text
  notes             String? @db.Text
  receipt_image_url String? @db.VarChar(500)

  is_verified Boolean   @default(false)
  verified_by Int?
  verified_at DateTime?

  transaction_date DateTime  @default(now())
  created_by       Int?
  updated_by       Int?
  deleted_at       DateTime?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  t_expense_category t_expense_category? @relation(fields: [category_id], references: [category_id])
  m_tenant           m_tenant            @relation(fields: [tenant_id], references: [tenant_id])
  t_sale_transaction t_transaction?      @relation("SaleTransaction", fields: [sale_transaction_id], references: [transaction_id])
  m_user_verified_by m_user?             @relation("CashTransactionVerifiedBy", fields: [verified_by], references: [user_id])
  m_user_created_by  m_user?             @relation("CashTransactionCreatedBy", fields: [created_by], references: [user_id])
  m_user_updated_by  m_user?             @relation("CashTransactionUpdatedBy", fields: [updated_by], references: [user_id])

  @@index([tenant_id])
  @@index([transaction_type])
  @@index([transaction_date])
  @@index([payment_method])
  @@index([sale_transaction_id])
  @@index([category_id])
  @@index([is_verified])
  @@map("t_cash_transaction")
}

model t_return {
  return_id               Int            @id @default(autoincrement())
  return_number           Int
  original_transaction_id Int
  tenant_id               Int
  cashier_id              Int
  return_total            Decimal        @db.Decimal(12, 2)
  refund_amount           Decimal        @db.Decimal(12, 2)
  refund_method           payment_method @default(CASH)
  notes                   String?        @db.Text
  created_at              DateTime       @default(now())
  created_by              Int?

  t_return_item          t_return_item[]
  m_user                 m_user          @relation(fields: [cashier_id], references: [user_id])
  m_tenant               m_tenant        @relation(fields: [tenant_id], references: [tenant_id])
  t_original_transaction t_transaction   @relation("OriginalTransaction", fields: [original_transaction_id], references: [transaction_id])
  m_user_created_by      m_user?         @relation("ReturnCreatedBy", fields: [created_by], references: [user_id])

  @@index([tenant_id])
  @@index([original_transaction_id])
  @@index([created_at])
  @@map("t_return")
}

model t_return_item {
  return_item_id Int     @id @default(autoincrement())
  return_id      Int
  product_id     Int
  quantity       Int
  price          Decimal @db.Decimal(10, 2)
  subtotal       Decimal @db.Decimal(12, 2)

  t_return  t_return  @relation(fields: [return_id], references: [return_id], onDelete: Cascade)
  m_product m_product @relation(fields: [product_id], references: [product_id])

  @@index([return_id])
  @@index([product_id])
  @@map("t_return_item")
}
